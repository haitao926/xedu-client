<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jupyter Notebook Client - é‡æ„ç‰ˆ</title>
    <link rel="stylesheet" href="./styles/main.css">
    <style>
        /* ä¸´æ—¶æ ·å¼ï¼Œç”¨äºAIåŠ©æ‰‹é¡µé¢ */
        .ai-chat-layout {
            display: flex;
            height: calc(100vh - 200px);
            gap: 0;
        }

        .chat-sidebar {
            width: 200px;
            background: #f8f9fa;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-container {
            flex: 1;
            background: #ffffff;
            overflow-y: auto;
            padding: 0;
            max-height: none;
            border: 1px solid #e5e7eb;
        }

        .chat-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            text-align: center;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .chat-empty-icon {
            font-size: 100px;
            margin-bottom: 30px;
            opacity: 0.3;
        }

        .chat-empty-text {
            font-size: 18px;
            color: #666;
            line-height: 1.8;
            font-weight: 500;
        }

        .chat-message {
            display: flex;
            gap: 16px;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            animation: fadeIn 0.4s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message:last-child {
            border-bottom: none;
        }

        .chat-message.answer {
            background: #f8f9fa;
        }

        .message-avatar {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-avatar.ai-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message-avatar.user-avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .message-content-wrapper {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .message-sender {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .message-time {
            font-size: 12px;
            color: #999;
        }

        .message-content {
            font-size: 15px;
            line-height: 1.7;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .ai-input-fixed {
            padding: 16px 24px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .ai-input-container {
            display: flex;
            gap: 10px;
            background: #f8f9fa;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 12px;
            transition: all 0.3s;
        }

        .ai-input-container:focus-within {
            border-color: #667eea;
            background: white;
        }

        .btn-attach, .btn-send {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .btn-attach {
            background: #e5e7eb;
            color: #666;
        }

        .btn-attach:hover {
            background: #d1d5db;
            transform: scale(1.05);
        }

        .btn-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-send:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .ai-textarea-fixed {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-size: 15px;
            line-height: 1.6;
            font-family: inherit;
            max-height: 300px;
            padding: 12px 8px;
            background: transparent;
        }

        .ai-input-hint {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 6px;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ ‡é¢˜ -->
        <div class="header">
            <h1>âš¡ Jupyter Notebook Client</h1>
            <p>ä¸“ä¸šçš„ Jupyter Notebook æ¡Œé¢ç®¡ç†å·¥å…· | é‡æ„ç‰ˆæœ¬ v2.0</p>
            <p style="margin-top: 10px; font-size: 12px;">
                API æœåŠ¡å™¨: <strong id="api-status">æ£€æµ‹ä¸­...</strong> |
                çŠ¶æ€: <strong id="connection-status">æœªè¿æ¥</strong>
            </p>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="app.switchTab('main')">
                ğŸ  ä¸»æ§åˆ¶å°
            </button>
            <button class="nav-tab" onclick="app.switchTab('settings')">
                âš™ï¸ ç³»ç»Ÿè®¾ç½®
            </button>
            <button class="nav-tab" onclick="app.switchTab('ai-assistant')">
                ğŸ¤– AI åŠ©æ‰‹
            </button>
        </div>

        <!-- ä¸»æ§åˆ¶å° -->
        <div id="main" class="tab-content active">
            <div class="main-content">
                <!-- é¡¹ç›®è®¾ç½® -->
                <div class="card">
                    <h2>ğŸ“ é¡¹ç›®è®¾ç½®</h2>
                    <div class="drop-zone" id="drop-zone" onclick="document.getElementById('folder-input').click()">
                        <div class="icon">ğŸ“‚</div>
                        <div class="text">æ‹–æ‹½æ–‡ä»¶å¤¹åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                        <div class="hint">æ”¯æŒå°†é¡¹ç›®æ–‡ä»¶å¤¹æ‹–æ‹½åˆ°æ­¤å¤„</div>
                        <input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">
                    </div>
                    <div class="path-display" style="margin-top: 20px;">
                        <label>é¡¹ç›®ç›®å½•è·¯å¾„</label>
                        <input type="text" id="project-path" placeholder="ä¾‹å¦‚: C:\Users\ç”¨æˆ·å\Documents\é¡¹ç›®æ–‡ä»¶å¤¹"
                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; margin-bottom: 10px;">
                        <button class="btn btn-info" onclick="confirmProjectPath()" style="width: 100%; margin-top: 5px;">
                            <span>âœ“</span> ç¡®è®¤è·¯å¾„
                        </button>
                    </div>
                </div>

                <!-- Jupyter æ§åˆ¶é¢æ¿ -->
                <div id="control-panel">
                    <!-- è¿™é‡Œä¼šè¢« ControlPanel ç»„ä»¶å¡«å…… -->
                </div>

                <!-- çŠ¶æ€æ  -->
                <div id="status-container">
                    <!-- è¿™é‡Œä¼šè¢« StatusBar ç»„ä»¶å¡«å…… -->
                </div>

                <!-- å®æ—¶æ—¥å¿— -->
                <div class="card full-width">
                    <h2>ğŸ“ å®æ—¶æ—¥å¿—</h2>
                    <div class="btn-group" style="margin-bottom: 15px;">
                        <button class="btn btn-secondary" onclick="app.clearLog()">
                            <span>ğŸ—‘ï¸</span> æ¸…ç©ºæ—¥å¿—
                        </button>
                        <button class="btn btn-info" onclick="exportLog()">
                            <span>ğŸ’¾</span> å¯¼å‡ºæ—¥å¿—
                        </button>
                        <button class="btn btn-secondary" onclick="logger.toggleAutoScroll()">
                            <span>ğŸ“œ</span> è‡ªåŠ¨æ»šåŠ¨
                        </button>
                    </div>
                    <div id="log-container" class="log-container">
                        <div class="log-line log-info">
                            <span class="log-time">[--:--:--]</span>
                            ç³»ç»Ÿå¯åŠ¨ï¼Œç­‰å¾… Jupyter Notebook Client åˆå§‹åŒ–...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿè®¾ç½® -->
        <div id="settings" class="tab-content">
            <!-- ç³»ç»Ÿä¿¡æ¯ -->
            <div class="card" style="margin-bottom: 20px;">
                <h2>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>
                <div class="info-grid">
                    <div class="info-card">
                        <h3>Python ç‰ˆæœ¬</h3>
                        <div class="value" id="python-version">-</div>
                        <p>å½“å‰ Python è§£é‡Šå™¨ç‰ˆæœ¬</p>
                    </div>
                    <div class="info-card">
                        <h3>Jupyter ç‰ˆæœ¬</h3>
                        <div class="value" id="jupyter-version">-</div>
                        <p>Jupyter Notebook æ¡†æ¶ç‰ˆæœ¬</p>
                    </div>
                    <div class="info-card">
                        <h3>æ“ä½œç³»ç»Ÿ</h3>
                        <div class="value" id="os-info">-</div>
                        <p>å½“å‰è¿è¡Œå¹³å°</p>
                    </div>
                    <div class="info-card">
                        <h3>API çŠ¶æ€</h3>
                        <div class="value" id="api-health">æ£€æµ‹ä¸­...</div>
                        <p>Flask API è¿æ¥çŠ¶æ€</p>
                    </div>
                </div>
            </div>

            <!-- é…ç½®è®¾ç½® -->
            <div class="card" style="margin-bottom: 20px;">
                <h2>âš™ï¸ å…¨å±€é…ç½®</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>API æœåŠ¡å™¨åœ°å€</label>
                        <input type="text" id="config-api-base" value="http://127.0.0.1:5000">
                    </div>
                    <div class="form-group">
                        <label>çŠ¶æ€åˆ·æ–°é—´éš” (æ¯«ç§’)</label>
                        <input type="number" id="config-refresh-interval" value="2000" min="1000" max="60000">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="config-auto-open-browser" checked> å¯åŠ¨åè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
                    </label>
                </div>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="saveGlobalConfig()">
                        <span>ğŸ’¾</span> ä¿å­˜é…ç½®
                    </button>
                    <button class="btn btn-secondary" onclick="loadGlobalConfig()">
                        <span>ğŸ”„</span> é‡æ–°åŠ è½½
                    </button>
                </div>
            </div>

            <!-- AIåŠ©æ‰‹é…ç½® -->
            <div class="card">
                <h2>ğŸ¤– AI åŠ©æ‰‹é…ç½®</h2>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="ai-api-key" placeholder="è¾“å…¥ Moonshot API Key">
                </div>
                <div class="form-group">
                    <label>Base URL</label>
                    <input type="text" id="ai-base-url" value="https://api.moonshot.cn/v1" placeholder="https://api.moonshot.cn/v1">
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹</label>
                    <select id="ai-model" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        <option value="moonshot-v1-8k-vision-preview">moonshot-v1-8k-vision-preview</option>
                        <option value="moonshot-v1-32k-vision-preview">moonshot-v1-32k-vision-preview</option>
                        <option value="moonshot-v1-128k-vision-preview">moonshot-v1-128k-vision-preview</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="saveAIConfig()">
                        <span>ğŸ’¾</span> ä¿å­˜ AI é…ç½®
                    </button>
                    <button class="btn btn-success" onclick="testAIConfig()">
                        <span>ğŸ§ª</span> æµ‹è¯•è¿æ¥
                    </button>
                </div>
            </div>
        </div>

        <!-- AIåŠ©æ‰‹ -->
        <div id="ai-assistant" class="tab-content">
            <div class="ai-chat-layout">
                <!-- å·¦ä¾§èŠå¤©å†å²åˆ—è¡¨ -->
                <div class="chat-sidebar">
                    <div class="sidebar-header" style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333;">ğŸ’¬ å¯¹è¯å†å²</h3>
                        <button class="btn btn-info" style="width: 100%;" onclick="startNewChat()">
                            <span>â•</span> æ–°å¯¹è¯
                        </button>
                    </div>
                    <div class="chat-list" style="flex: 1; overflow-y: auto; padding: 10px;">
                        <div class="chat-item" style="display: flex; gap: 12px; padding: 12px; border-radius: 10px; cursor: pointer; background: #f0f0f0;">
                            <div class="chat-item-icon" style="width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ¤–</div>
                            <div class="chat-item-info" style="flex: 1; min-width: 0;">
                                <div class="chat-item-title" style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">é»˜è®¤å¯¹è¯</div>
                                <div class="chat-item-preview" style="font-size: 12px; opacity: 0.7;">è¿˜æ²¡æœ‰æ¶ˆæ¯</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ä¸»èŠå¤©åŒºåŸŸ -->
                <div class="chat-main">
                    <!-- èŠå¤©æ ‡é¢˜æ  -->
                    <div class="chat-main-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e5e7eb; background: white;">
                        <h2 style="margin: 0; font-size: 20px; color: #333;">ğŸ¤– Kimi è§†è§‰åŠ©æ‰‹</h2>
                        <div class="header-actions">
                            <button class="btn btn-danger" style="padding: 8px 16px;" onclick="clearCurrentChat()">
                                <span>ğŸ—‘ï¸</span> æ¸…ç©ºå½“å‰
                            </button>
                        </div>
                    </div>

                    <!-- èŠå¤©å†…å®¹åŒº -->
                    <div id="chat-history" class="chat-container">
                        <div class="chat-empty">
                            <div class="chat-empty-icon">ğŸ¤–</div>
                            <div class="chat-empty-text">å¼€å§‹æ–°å¯¹è¯å§ï¼<br>ä¸Šä¼ å›¾ç‰‡å¹¶æé—®</div>
                        </div>
                    </div>

                    <!-- åº•éƒ¨è¾“å…¥åŒº -->
                    <div class="ai-input-fixed">
                        <div class="ai-input-container">
                            <button class="btn-attach" onclick="document.getElementById('ai-image-input').click()">
                                <span>ğŸ“</span>
                            </button>
                            <textarea id="ai-question" rows="1" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¯¢é—®çš„é—®é¢˜..."
                                    class="ai-textarea-fixed" onkeydown="handleAIKeyDown(event)"></textarea>
                            <button class="btn-send" id="btn-send" onclick="askAI()">
                                <span>â¤</span>
                            </button>
                            <input type="file" id="ai-image-input" accept="image/*" style="display: none;">
                        </div>
                        <div class="ai-input-hint">
                            æ”¯æŒå›¾ç‰‡ä¸Šä¼ ï¼ŒKimi AI å¯ä»¥åˆ†æå›¾ç‰‡å†…å®¹
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript æ¨¡å— -->
    <script type="module">
        // å¯¼å…¥åº”ç”¨æ¨¡å—
        import app from './utils/app.js';
        import StatusBar from './components/StatusBar.js';
        import ControlPanel from './components/ControlPanel.js';
        import logger from './utils/logger.js';
        import configManager from './utils/config.js';
        import apiClient from './utils/api.js';

        // å°†åº”ç”¨å®ä¾‹æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿HTMLä¸­çš„onclickå¯ä»¥è®¿é—®
        window.app = app;
        window.logger = logger;
        window.configManager = configManager;
        window.apiClient = apiClient;

        // ç»„ä»¶å®ä¾‹
        let statusBar, controlPanel;

        // åˆå§‹åŒ–åº”ç”¨
        async function initializeApp() {
            try {
                // åˆå§‹åŒ–åº”ç”¨æ ¸å¿ƒ
                await app.init();

                // åˆå§‹åŒ–ç»„ä»¶
                statusBar = new StatusBar('status-container');
                controlPanel = new ControlPanel('control-panel');

                // åŠ è½½ç³»ç»Ÿä¿¡æ¯
                await loadSystemInfo();

                // è®¾ç½®é¡µé¢äº‹ä»¶
                setupPageEvents();

                logger.success('ğŸ‰ åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨äº†ï¼');

            } catch (error) {
                logger.error(`âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                console.error('App initialization failed:', error);
            }
        }

        // åŠ è½½ç³»ç»Ÿä¿¡æ¯
        async function loadSystemInfo() {
            try {
                const result = await apiClient.detectPython();
                if (result.success && result.info) {
                    document.getElementById('python-version').textContent = result.info.python_version || '-';
                    document.getElementById('jupyter-version').textContent = result.info.jupyterlab_version || result.info.jupyter_version || '-';
                    document.getElementById('os-info').textContent = result.info.platform || '-';
                }
            } catch (error) {
                logger.warn('æ— æ³•åŠ è½½ç³»ç»Ÿä¿¡æ¯');
            }
        }

        // è®¾ç½®é¡µé¢äº‹ä»¶
        function setupPageEvents() {
            // ç›‘å¬APIè¿æ¥çŠ¶æ€
            document.addEventListener('api:connected', () => {
                document.getElementById('api-status').textContent = 'æ­£å¸¸';
                document.getElementById('api-status').style.color = '#16a34a';
                document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                document.getElementById('connection-status').style.color = '#16a34a';
                document.getElementById('api-health').textContent = 'æ­£å¸¸';
            });

            document.addEventListener('api:disconnected', () => {
                document.getElementById('api-status').textContent = 'ç¦»çº¿';
                document.getElementById('api-status').style.color = '#dc2626';
                document.getElementById('connection-status').textContent = 'æœªè¿æ¥';
                document.getElementById('connection-status').style.color = '#dc2626';
                document.getElementById('api-health').textContent = 'ç¦»çº¿';
            });

            // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
            setupDragAndDrop();
        }

        // æ‹–æ‹½åŠŸèƒ½
        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            const folderInput = document.getElementById('folder-input');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
            folderInput.addEventListener('change', handleFileSelect);

            function handleDrop(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFiles(files);
                }
            }

            function handleFileSelect(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    handleFiles(files);
                }
            }

            function handleFiles(files) {
                if (files.length > 0) {
                    const firstFile = files[0];
                    let folderName = '';

                    if (firstFile.webkitRelativePath) {
                        const pathParts = firstFile.webkitRelativePath.split('/');
                        folderName = pathParts[0] || '';
                    }

                    if (folderName) {
                        document.getElementById('project-path').value = folderName;
                        logger.info(`ğŸ“ å·²é€‰æ‹©æ–‡ä»¶å¤¹: ${folderName}`);
                        logger.info(`ğŸ“Š æ£€æµ‹åˆ° ${files.length} ä¸ªæ–‡ä»¶`);
                    }
                }
            }
        }

        // å…¨å±€å‡½æ•°ï¼ˆä¾›HTMLè°ƒç”¨ï¼‰
        window.confirmProjectPath = function() {
            const projectPath = document.getElementById('project-path').value.trim();
            if (!projectPath) {
                logger.warn('âš ï¸ è¯·è¾“å…¥é¡¹ç›®ç›®å½•è·¯å¾„');
                return;
            }

            configManager.set('jupyter.projectDir', projectPath);
            logger.success('âœ… é¡¹ç›®è·¯å¾„å·²ç¡®è®¤');
            logger.info(`ğŸ“ è·¯å¾„: ${projectPath}`);
        };

        window.exportLog = function() {
            const logData = logger.export();
            if (logData) {
                const blob = new Blob([logData.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = logData.filename;
                a.click();
                URL.revokeObjectURL(url);
                logger.success('âœ… æ—¥å¿—å·²å¯¼å‡º');
            }
        };

        window.saveGlobalConfig = function() {
            const apiBase = document.getElementById('config-api-base').value;
            const refreshInterval = parseInt(document.getElementById('config-refresh-interval').value);
            const autoOpenBrowser = document.getElementById('config-auto-open-browser').checked;

            configManager.setMultiple({
                'api.baseURL': apiBase,
                'ui.refreshInterval': refreshInterval,
                'ui.autoOpenBrowser': autoOpenBrowser
            });

            configManager.save();
            logger.success('âœ… å…¨å±€é…ç½®å·²ä¿å­˜');
        };

        window.loadGlobalConfig = function() {
            document.getElementById('config-api-base').value = configManager.get('api.baseURL');
            document.getElementById('config-refresh-interval').value = configManager.get('ui.refreshInterval');
            document.getElementById('config-auto-open-browser').checked = configManager.get('ui.autoOpenBrowser');
            logger.info('âœ… é…ç½®å·²é‡æ–°åŠ è½½');
        };

        window.saveAIConfig = function() {
            const config = {
                apiKey: document.getElementById('ai-api-key').value,
                baseURL: document.getElementById('ai-base-url').value,
                model: document.getElementById('ai-model').value
            };

            localStorage.setItem('ai_config', JSON.stringify(config));
            logger.success('âœ… AI é…ç½®å·²ä¿å­˜');
        };

        window.testAIConfig = function() {
            const config = JSON.parse(localStorage.getItem('ai_config') || '{}');
            if (config.apiKey) {
                logger.success('âœ… AI é…ç½®å·²ä¿å­˜ï¼Œå¯ä»¥ä½¿ç”¨');
            } else {
                logger.warn('âš ï¸ è¯·å…ˆé…ç½® API Key');
            }
        };

        window.startNewChat = function() {
            clearCurrentChat();
            logger.info('ğŸ’¬ å·²å¼€å§‹æ–°å¯¹è¯');
        };

        window.clearCurrentChat = function() {
            const chatHistory = document.getElementById('chat-history');
            chatHistory.innerHTML = `
                <div class="chat-empty">
                    <div class="chat-empty-icon">ğŸ¤–</div>
                    <div class="chat-empty-text">å¼€å§‹æ–°å¯¹è¯å§ï¼<br>ä¸Šä¼ å›¾ç‰‡å¹¶æé—®</div>
                </div>
            `;
            document.getElementById('ai-question').value = '';
            document.getElementById('ai-image-input').value = '';
        };

        window.handleAIKeyDown = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                window.askAI();
            }
        };

        window.askAI = async function() {
            const config = JSON.parse(localStorage.getItem('ai_config') || '{}');
            if (!config.apiKey) {
                logger.warn('âš ï¸ è¯·å…ˆåœ¨è®¾ç½®é¡µé¢é…ç½® AI API Key');
                return;
            }

            const imageInput = document.getElementById('ai-image-input');
            const question = document.getElementById('ai-question').value.trim();

            if (!imageInput.files || !imageInput.files[0]) {
                logger.warn('âš ï¸ è¯·ä¸Šä¼ å›¾ç‰‡');
                return;
            }

            if (!question) {
                logger.warn('âš ï¸ è¯·è¾“å…¥é—®é¢˜');
                return;
            }

            const btn = document.getElementById('btn-send');
            btn.disabled = true;
            btn.innerHTML = '<span>â³</span>';

            try {
                // è½¬æ¢å›¾ç‰‡ä¸ºbase64
                const file = imageInput.files[0];
                const base64 = await fileToBase64(file);

                const response = await apiClient.askAI(base64, question, config);

                if (response.success) {
                    addToChatHistory(question, response.answer);
                    document.getElementById('ai-question').value = '';
                    imageInput.value = '';
                } else {
                    logger.error(`âŒ AI å›ç­”å¤±è´¥: ${response.message}`);
                }
            } catch (error) {
                logger.error(`âŒ AI è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>â¤</span>';
            }
        };

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function addToChatHistory(question, answer) {
            const chatHistory = document.getElementById('chat-history');

            // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºçŠ¶æ€
            if (chatHistory.children.length === 1 && chatHistory.children[0].classList.contains('chat-empty')) {
                chatHistory.innerHTML = '';
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

            // ç”¨æˆ·é—®é¢˜
            const qDiv = document.createElement('div');
            qDiv.className = 'chat-message question';
            qDiv.innerHTML = `
                <div class="message-avatar user-avatar">
                    <span>ğŸ‘¤</span>
                </div>
                <div class="message-content-wrapper">
                    <div class="message-header">
                        <span class="message-sender">æ‚¨</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-content">${question}</div>
                </div>
            `;

            // AIå›ç­”
            const aDiv = document.createElement('div');
            aDiv.className = 'chat-message answer';
            aDiv.innerHTML = `
                <div class="message-avatar ai-avatar">
                    <span>ğŸ¤–</span>
                </div>
                <div class="message-content-wrapper">
                    <div class="message-header">
                        <span class="message-sender">Kimi AI</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-content">${answer}</div>
                </div>
            `;

            chatHistory.appendChild(qDiv);
            chatHistory.appendChild(aDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeApp);

        // å¯¼å‡ºä¾›è°ƒè¯•ä½¿ç”¨
        window.debugApp = { statusBar, controlPanel };
    </script>
</body>
</html>